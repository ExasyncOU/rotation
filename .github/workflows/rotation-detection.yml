name: PDF Rotation Detection

on:
  # Ermöglicht manuellen Trigger über GitHub UI
  workflow_dispatch:
    inputs:
      pdf_url:
        description: 'URL zum PDF-Dokument'
        required: true
        type: string
      visualize:
        description: 'Visualisierung erstellen'
        required: false
        type: boolean
        default: false

  # Ermöglicht Trigger von N8N über repository_dispatch
  repository_dispatch:
    types: [detect-rotation]

jobs:
  detect-rotation:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Prepare File (PDF/PNG/JPEG)
        id: download
        run: |
          # Datei-Daten aus Input oder repository_dispatch Event
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            FILE_URL="${{ github.event.inputs.pdf_url }}"
            VISUALIZE="${{ github.event.inputs.visualize }}"
          else
            FILE_URL="${{ github.event.client_payload.pdf_url }}"
            FILE_BASE64="${{ github.event.client_payload.pdf_base64 }}"
            VISUALIZE="${{ github.event.client_payload.visualize }}"
          fi

          # Bestimme Dateiendung aus URL oder verwende .pdf als default
          if [ -n "$FILE_URL" ]; then
            # Extrahiere Dateiendung aus URL
            EXTENSION=$(echo "$FILE_URL" | grep -oP '\.(pdf|png|jpg|jpeg|bmp|tiff|tif)(\?.*)?$' | sed 's/\?.*//' || echo ".pdf")
          else
            EXTENSION=".pdf"
          fi

          OUTPUT_FILE="input${EXTENSION}"
          echo "Output file: $OUTPUT_FILE"

          # Prüfe ob Base64 oder URL
          if [ -n "$FILE_BASE64" ]; then
            echo "Decoding file from Base64..."
            echo "$FILE_BASE64" | base64 -d > "$OUTPUT_FILE"
            echo "File decoded successfully"
          elif [ -n "$FILE_URL" ]; then
            echo "Downloading file from: $FILE_URL"
            curl -L -o "$OUTPUT_FILE" "$FILE_URL"
            echo "File downloaded successfully"
          else
            echo "Error: Neither pdf_url nor pdf_base64 provided"
            exit 1
          fi

          # Prüfe ob Datei erfolgreich erstellt wurde
          if [ ! -f "$OUTPUT_FILE" ]; then
            echo "Error: $OUTPUT_FILE not created"
            exit 1
          fi

          FILE_SIZE=$(stat -c%s "$OUTPUT_FILE" 2>/dev/null || stat -f%z "$OUTPUT_FILE")
          echo "File size: $FILE_SIZE bytes"

          # Erkenne Dateityp mit 'file' command
          FILE_TYPE=$(file -b --mime-type "$OUTPUT_FILE")
          echo "Detected file type: $FILE_TYPE"

          echo "input_file=$OUTPUT_FILE" >> $GITHUB_OUTPUT
          echo "visualize=$VISUALIZE" >> $GITHUB_OUTPUT

      - name: Detect Rotation
        id: detect
        run: |
          INPUT_FILE="${{ steps.download.outputs.input_file }}"
          ARGS="$INPUT_FILE"

          if [ "${{ steps.download.outputs.visualize }}" == "true" ]; then
            ARGS="$ARGS --visualize"
          fi

          echo "Running rotation detection on: $INPUT_FILE"

          # Führe das Script aus und speichere den Exit-Code
          set +e
          python detect_rotation.py $ARGS 2>&1 | tee output.txt
          EXIT_CODE=${PIPESTATUS[0]}
          set -e

          echo "Python script exit code: $EXIT_CODE"

          # Extrahiere JSON-Ergebnis aus dem Output
          RESULT=$(grep -A 1 "::set-output" output.txt | tail -n 1 || echo "{}")
          echo "result=$RESULT" >> $GITHUB_OUTPUT

          # Fail if Python script failed
          exit $EXIT_CODE

      - name: Upload Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: rotation-results
          path: |
            output.txt
            *_lines_detected.jpg
            input.*
          retention-days: 7

      - name: Write Result to Job Summary
        run: |
          RESULT="${{ steps.detect.outputs.result }}"
          echo "## Rotation Detection Result" >> $GITHUB_STEP_SUMMARY
          echo '```json' >> $GITHUB_STEP_SUMMARY
          echo "$RESULT" | jq '.' >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

          # Schreibe auch in eine Datei für einfachen API-Zugriff
          echo "$RESULT" > result.json

      - name: Upload Result JSON
        uses: actions/upload-artifact@v4
        with:
          name: rotation-result-json
          path: result.json
          retention-days: 1

      - name: Post Results to Callback URL
        if: github.event.client_payload.callback_url != ''
        run: |
          RESULT="${{ steps.detect.outputs.result }}"
          CALLBACK_URL="${{ github.event.client_payload.callback_url }}"

          curl -X POST "$CALLBACK_URL" \
            -H "Content-Type: application/json" \
            -d "$RESULT"

      - name: Comment on Commit (optional)
        if: github.event.client_payload.create_comment == 'true'
        run: |
          echo "Results: ${{ steps.detect.outputs.result }}"
